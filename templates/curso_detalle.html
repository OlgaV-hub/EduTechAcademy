<!-- templates/curso_detalle.html -->
{% extends "base.html" %}

{% block content %}
{# URL для кнопки "Volver al listado" в зависимости от роли #}
{% set back_url = url_for('courses.listar_cursos') %}
{% if current_user.is_authenticated and current_user.role == 'estudiante' %}
  {% set back_url = url_for('estudiante.estudiante_todos_cursos') %}
{% endif %}
<div class="container my-4">

  <div class="row g-4">

    <div class="col-12 col-lg-8">
      <div class="card shadow-sm h-100">

        {% if curso.image_key %}
          <div class="course-thumb detail-thumb text-center p-3 border-bottom">
            <img src="{{ url_publica(curso.image_key) }}"
                 alt="Imagen del curso {{ curso.nombre }}"
                 class="course-thumb-img">
          </div>
        {% endif %}

        <div class="card-body">
          <h2 class="card-title fw-bold mb-2">{{ curso.nombre }}</h2>

          <p class="text-muted mb-4">
            {{ curso.descripcion or '—' }}
          </p>

          <!-- Precio base -->
          <div class="d-flex align-items-center gap-3 mb-3">
            <span class="badge text-bg-secondary">Precio base</span>
            <span class="fs-5">
              USD {{ '%.2f'|format(curso.precio or 0) }}
            </span>
          </div>

          <!-- Formulario de conversión de precios -->
          <form class="row gy-2 gx-2 align-items-end"
                method="post"
                action="{{ url_for('courses.convertir_precio', course_id=curso.id) }}">
            <input type="hidden" name="amount" value="{{ curso.precio }}">

            <div class="col-auto">
              <label class="form-label mb-1">Convertir a</label>
              <select class="form-select" name="to">
                <option value="ARS" {% if moneda == 'ARS' %}selected{% endif %}>ARS</option>
                <option value="EUR" {% if moneda == 'EUR' %}selected{% endif %}>EUR</option>
                <option value="BRL" {% if moneda == 'BRL' %}selected{% endif %}>BRL</option>
              </select>
            </div>

            <div class="col-auto">
              <button type="submit" class="btn btn-outline-primary">
                Convertir
              </button>
            </div>
          </form>

          <!-- Resultado/error de conversión -->
          {% if converted is defined and converted is not none and not error %}
            <div class="alert alert-success mt-3 mb-0">
              Precio convertido:
              <strong>{{ '%.2f'|format(converted) }} {{ moneda }}</strong>
            </div>
          {% elif error %}
            <div class="alert alert-warning mt-3 mb-0">
              {{ error }}
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-4">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h5 class="mb-3">Inscripción</h5>

          {% if not current_user.is_authenticated %}
            <a class="btn btn-primary w-100"
               href="{{ url_for('auth.login') }}">
              Iniciar sesión para inscribirte
            </a>
          {% elif current_user.role == 'estudiante' %}
            <form method="post"
                  action="{{ url_for('courses.inscribirme', course_id=curso.id) }}">
              <button class="btn btn-primary w-100" type="submit">
                Inscribirme
              </button>
            </form>
          {% else %}
            <div class="alert alert-info mt-2">
              Solo los estudiantes pueden inscribirse a los cursos.
            </div>
          {% endif %}

          <a class="btn btn-link w-100 mt-2"
              href="{{ back_url }}">
            Volver al listado
          </a>
        </div>
      </div>
    </div>

  </div>
</div>
{% endblock %}